<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">
<html>

<!-- #BeginTemplate "../home.dwt" -->

<head>
<!-- #BeginEditable "doctitle" -->
<title>Quest Engine</title>
<!-- #EndEditable -->
<link rel="stylesheet" href="../include/root.css" type="text/css" />
<script type="text/javascript" src="../include/root.js"></script>
<meta http-equiv="content-type" content="text/html; charset=Windows-1251" />
<meta name="author" content="alexei.fedotov.at.gmail.com" />
<meta name="document-state" content="static" />
</head>

<body class="float-text">
<p class="right-ref">[<a name="top" href="../index.html">home</a>]</p>

<!-- #BeginEditable "body" -->15 марта 1999 года
<h2>Квестовое ядро</h2>

<p>
<b>Ядро</b>&nbsp;&mdash; это программная компонента, которая исполняет основной поток управления.
Базовый цикл его работы можно представить следующим образом:
</p>

<ol>
<li>Обработать синхронные события.</li>
<li>Обработать события, возникшие от действий пользователя.</li>
<li>Вызвать СУП&nbsp;&mdash; сделать ход за компьютерных игроков.</li>
<li>Отдать команды на перемещение персонажей маршрутизатору.</li>
<li>Отдать команду 3D движку на отрисовку кадра.</li>
<li>Получить от 3D движка информацию о новом положении объектов и, возможно, некоторую дополнительную информацию.</li>
<li>Сгенерировать на основе этой информации множество асинхронных событий, найти для каждого из них свой обработчик и вызвать его.</li>
</ol>

<p>
Расшифруем некоторые из встретившихся выше понятий.
</p>

<p>
<b>События</b> бывают синхронными либо асинхронными. События первого типа приходят от таймера&nbsp;&mdash; они отвечают, например, за смену дня и ночи. События второго типа генерируются на основе информации, получаемой от 3D движка, либо интерфейсным модулем, либо СУПом (когда персонаж за кадром совершает какое-нибудь действие). Существует определенная классификация (иерархия) таких событий:
</p>

<ol>
<li>Пересечение объектом  N полигона номер P (пример: герой проходит мимо охранника внутри полицейского участка).</li>
<li>Столкновение объекта  N с объектом M (пример: попадание струей воды в бомжа).</li>
<li>Столкновение объекта N со стеной M (пример: попадание камнем в стекло).</li>
<li>Использование персонажем P объекта N на объект M (пример: использование героем электрошока на старушку).</li>
<li>TBD</li>
</ol>

<p>
Первые три события случаются при передвижении объектов в мире (поступают от 3D движка), последнее&nbsp;&mdash; генерируется интерфейсным модулем.
Для каждого вида событий существует хэш-массив, содержащий адреса обработчиков событий. Индекс в массиве определяется строкой-описанием события. Скажем, когда зомби Zombie выпивает пиво, СУП генерирует событие типа Use c параметром "Zombie:Beer:Zombie". Ядро интерпретирует это событие, вычисляя по этой строке адрес нужного обработчика, и вызывает его.
</p>

<p>
<b>СУП</b> (система управления персонажами)&nbsp;&mdash; набор процедур, отвечающих за действия компьютерных персонажей, другими словами, искусственный интеллект. Результатом работы СУП может быть некоторое квестовое действие со стороны персонажа (событие), либо изменение маршрута его передвижения.
</p>

<p>
<b>Маршрутизатор</b>&nbsp;&mdash; это преобразователь высокоуровневых команд на перемещение вида "кто-Zombie,куда-кладбище", выдаваемых СУПом или непосредственно ядром, в низкоуровневые команды для 3D движка.
<p>

<p>
Каждому предмету и каждому персонажу соответствует объект некоторого класса C++. В данных класса находится ссылка на элемент Архива, содержащий ресурсы для этого объекта. Инициализация объекта происходит в момент загрузки соответствующей части Архива с диска.
</p>

<p>
<b>Архив</b>&nbsp;&mdash;  это древовидная структура произвольной степени вложенности для упорядоченного хранения на диске разнородных данных. Каждый элемент архива имеет имя и описание формата содержащихся в нем данных. Архив оптимизирован на чтение. В настоящий момент полностью разработан низкоуровневый программный интерфейс для архива и на его базе создана оболочка для его заполнения и редактирования. Эта оболочка позволяет асоциировать форматы данных архива с определенными приложениями и далее работать с ними в тесном взаимодействии&nbsp;&mdash; отправлять им файлы на редактирование и получать от них свежие версии (связь осуществляется с помощью механизма DDE).
</p>

<p>
Таким образом, процесс добавления в сценарий нового элемента делится на два этапа. На первом этапе мы создаем в архиве новый блок, соответствующий этому элементу. Например, в случае с предметом этот блок может включать в себя его графическое изображение,  курсор мыши, изображаемый при наведении мыши на предмет, строку-описание, звуковые клипы-подсказки. Второй этап состоит из написания обработчиков событий, связанных с этим объектом, и добавления их к множеству существующих обработчиков.
</p>

<!-- #EndEditable -->

<p>&nbsp;</p>

<p class="right-ref">[<a href="#top">top</a>] [<a name="top" href="../index.html">home</a>]</p>
</body>

<!-- #EndTemplate -->

</html>
